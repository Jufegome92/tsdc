<form class="tsdc sheet" autocomplete="off">
  <section class="t-card t-col" style="gap:12px;">
    <header class="t-row">
      <h1 style="margin:0;">{{actor.name}}</h1>
      <div class="t-right muted">{{localize "TSDC.System"}}</div>
    </header>

    <nav class="sheet-tabs t-row" data-group="primary">
      <a class="item" data-tab="main">Básico</a>
      <a class="item" data-tab="rolls">Tiradas</a>
      <a class="item" data-tab="specs">Especializaciones</a>
    </nav>

    <section class="sheet-body">
      <div class="tab t-col" data-group="primary" data-tab="main">
        <div class="t-grid t-grid-3">

          {{!-- Atributos --}}
          <div class="t-card t-col">
            <h3 style="margin:0 0 6px 0;">Atributos</h3>

            <div class="t-field">
              <label>{{labels.strength}}</label>
              <input type="number" name="system.attributes.strength" value="{{system.attributes.strength}}" />
            </div>
            <div class="t-field">
              <label>{{labels.agility}}</label>
              <input type="number" name="system.attributes.agility" value="{{system.attributes.agility}}" />
            </div>
            <div class="t-field">
              <label>{{labels.tenacity}}</label>
              <input type="number" name="system.attributes.tenacity" value="{{system.attributes.tenacity}}" />
            </div>
            <div class="t-field">
              <label>{{labels.cunning}}</label>
              <input type="number" name="system.attributes.cunning" value="{{system.attributes.cunning}}" />
            </div>
            <div class="t-field">
              <label>{{labels.wisdom}}</label>
              <input type="number" name="system.attributes.wisdom" value="{{system.attributes.wisdom}}" />
            </div>
            <div class="t-field">
              <label>{{labels.intellect}}</label>
              <input type="number" name="system.attributes.intellect" value="{{system.attributes.intellect}}" />
            </div>
            <div class="t-field">
              <label>{{labels.aura}}</label>
              <input type="number" name="system.attributes.aura" value="{{system.attributes.aura}}" />
            </div>
            <div class="t-field">
              <label>{{labels.composure}}</label>
              <input type="number" name="system.attributes.composure" value="{{system.attributes.composure}}" />
            </div>
            <div class="t-field">
              <label>{{labels.presence}}</label>
              <input type="number" name="system.attributes.presence" value="{{system.attributes.presence}}" />
            </div>
          </div>

          {{!-- Derivados --}}
          <div class="t-card t-col">
            <h3 style="margin:0 0 6px 0;">Derivados</h3>
            <div class="t-row">
              <div class="t-field" style="flex:1;">
                <label>{{labels.prep}}</label>
                <input type="number" value="{{system.derived.preparation}}" disabled />
              </div>
              <div class="t-field" style="flex:1;">
                <label>{{labels.resi}}</label>
                <input type="number" value="{{system.derived.resilience}}" disabled />
              </div>
            </div>
            <span class="muted">Se recalculan automáticamente con tus atributos.</span>
          </div>

          {{!-- Notas --}}
          <div class="t-card t-col">
            <h3 style="margin:0 0 6px 0;">Notas</h3>
            <textarea name="system.notes" rows="8">{{system.notes}}</textarea>
          </div>

        </div>
      </div>

      {{!-- Tiradas (ATAQUE / IMPACTO / DEFENSA / RESISTENCIA) --}}
      <div class="tab t-col" data-group="primary" data-tab="rolls" style="gap:12px;">

        {{!-- ATAQUE --}}
        <div class="t-card t-col">
          <h3 style="margin:0 0 6px 0;">Ataque</h3>
          <div class="t-row" style="gap:12px; align-items:flex-end;">
            <div class="t-field" style="min-width:180px;">
              <label>Clave (arma o maniobra)</label>
              <input type="text" name="atkKey" placeholder="p.ej. katana, barrido, etc." />
            </div>
            <div class="t-field" style="width:120px;">
              <label>¿Es maniobra?</label>
              <input type="checkbox" name="atkIsManeuver" />
            </div>
            <div class="t-field" style="min-width:160px;">
              <label>Atributo (ataque)</label>
              <select name="atkAttr">
                <option value="strength">Fuerza</option>
                <option value="agility" selected>Agilidad</option>
                <option value="tenacity">Tenacidad</option>
                <option value="cunning">Astucia</option>
                <option value="wisdom">Sabiduría</option>
                <option value="intellect">Intelecto</option>
                <option value="aura">Aura</option>
                <option value="composure">Compostura</option>
                <option value="presence">Presencia</option>
              </select>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Bono</label>
              <input type="number" name="atkBonus" value="0"/>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Penal.</label>
              <input type="number" name="atkPenalty" value="0"/>
            </div>
            <button type="button" class="t-btn" data-action="atk-roll">Tirar Ataque</button>
          </div>
          <span class="muted">Usa 1d10 + nivel de competencia (arma/maniobra) + atributo + bono - penal. Aplica Ventaja Evolutiva.</span>
        </div>

        {{!-- IMPACTO --}}
        <div class="t-card t-col">
          <h3 style="margin:0 0 6px 0;">Impacto (cuerpo a cuerpo)</h3>
          <div class="t-row" style="gap:12px; align-items:flex-end;">
            <div class="t-field" style="min-width:180px;">
              <label>Clave de arma</label>
              <input type="text" name="impKey" placeholder="p.ej. katana, lancea, etc." />
            </div>
            <div class="t-field" style="width:120px;">
              <label>Dado</label>
              <select name="impDie">
                <option value="d4">d4</option>
                <option value="d6" selected>d6</option>
                <option value="d8">d8</option>
                <option value="d10">d10</option>
                <option value="d12">d12</option>
              </select>
            </div>
            <div class="t-field" style="width:120px;">
              <label>Grado</label>
              <input type="number" name="impGrade" value="1"/>
            </div>
            <div class="t-field" style="min-width:160px;">
              <label>Atributo (impacto)</label>
              <select name="impAttr">
                <option value="strength">Fuerza</option>
                <option value="agility" selected>Agilidad</option>
                <option value="tenacity">Tenacidad</option>
                <option value="cunning">Astucia</option>
                <option value="wisdom">Sabiduría</option>
                <option value="intellect">Intelecto</option>
                <option value="aura">Aura</option>
                <option value="composure">Compostura</option>
                <option value="presence">Presencia</option>
              </select>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Bono</label>
              <input type="number" name="impBonus" value="0"/>
            </div>
            <button type="button" class="t-btn" data-action="imp-roll">Tirar Impacto</button>
          </div>
          <span class="muted">(rango × dado) + (atributo × grado + bono). Sin progreso.</span>
        </div>

        {{!-- DEFENSA --}}
        <div class="t-card t-col">
          <h3 style="margin:0 0 6px 0;">Defensa</h3>
          <div class="t-row" style="gap:12px; align-items:flex-end;">
            <div class="t-field" style="min-width:160px;">
              <label>Tipo de armadura (para progreso si fallas)</label>
              <select name="defArmorType">
                <option value="light">Ligera</option>
                <option value="medium">Intermedia</option>
                <option value="heavy">Pesada</option>
              </select>
            </div>
            <div class="t-field" style="width:120px;">
              <label>Bono de armadura</label>
              <input type="number" name="defArmorBonus" value="0"/>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Bono</label>
              <input type="number" name="defBonus" value="0"/>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Penal.</label>
              <input type="number" name="defPenalty" value="0"/>
            </div>
            <button type="button" class="t-btn" data-action="def-roll">Tirar Defensa</button>
          </div>
          <span class="muted">1d10 + competencia evasiva + Agilidad + armadura + bono - penal. Si aprendes: éxito → Evasión, fallo → tipo de armadura.</span>
        </div>

        {{!-- RESISTENCIA --}}
        <div class="t-card t-col">
          <h3 style="margin:0 0 6px 0;">Resistencias</h3>
          <div class="t-row" style="gap:12px; align-items:flex-end;">
            <div class="t-field" style="min-width:180px;">
              <label>Tipo</label>
              <select name="resType">
                <option value="poison">Veneno</option>
                <option value="infection">Infección</option>
                <option value="affliction">Aflicción</option>
                <option value="curse">Maldición</option>
                <option value="alteration">Alteración</option>
                <option value="water">Agua</option>
                <option value="fire">Fuego</option>
                <option value="earth">Tierra</option>
                <option value="air">Viento</option>
                <option value="light">Luz</option>
                <option value="dark">Oscuridad</option>
              </select>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Bono</label>
              <input type="number" name="resBonus" value="0"/>
            </div>
            <div class="t-field" style="width:100px;">
              <label>Penal.</label>
              <input type="number" name="resPenalty" value="0"/>
            </div>
            <button type="button" class="t-btn" data-action="res-roll">Tirar Resistencia</button>
          </div>
          <span class="muted">Un solo dado (sin elección). Fallo → progreso en esa resistencia.</span>
        </div>

      </div>


      <div class="t-card t-col">
        <h3 style="margin:0 0 6px 0;">Trasfondo / Afinidad</h3>
        <div class="t-row" style="gap:8px;">
          <div class="t-field">
            <label>Trasfondo</label>
            <select name="background">
              {{#each background.options}}
                <option value="{{this.key}}" {{#if (eq ../background.current this.key)}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-col muted" style="justify-content:center;">
            <span>• Categoría afín progresa con umbral <strong>5</strong></span>
            <span>• Otras categorías con umbral <strong>10</strong></span>
          </div>
        </div>

      {{!-- ================================
          NUEVA PESTAÑA: ESPECIALIZACIONES
          ================================ --}}
      <div class="tab t-col" data-group="primary" data-tab="specs" style="gap:12px;">

        <div class="t-row" style="gap:8px;">
          <div class="t-field" style="flex:1;">
            <label>Buscar</label>
            <input type="text" name="specSearch" placeholder="Escribe para filtrar (p. ej. arqueo, acro, nego...)" />
          </div>
          <div class="t-field">
            <label>Mostrar</label>
            <select name="specFilter">
              <option value="all">Todas</option>
              <option value="favorites">Favoritas</option>
              <option value="physical">Físicas</option>
              <option value="mental">Mentales</option>
              <option value="social">Sociales</option>
              <option value="arts">Artes y Oficios</option>
              <option value="knowledge">Saberes</option>
            </select>
          </div>
        </div>

        {{!-- Favoritos arriba (si hay) --}}
        {{#if specs.favorites.length}}
        <div class="t-card t-col">
          <h3 style="margin:0;">⭐ Favoritas</h3>
          <div class="t-col" style="gap:6px;">
            {{#each specs.favorites}}
              <div class="t-row" data-spec="{{this.key}}" style="gap:8px; align-items:center;">
                <strong style="min-width:160px;">{{this.label}}</strong>
                <span class="muted" title="Atributo base">{{this.attrLabel}}</span>
                <span class="muted">Rango {{this.rank}} • Progreso {{this.progress}}/{{this.threshold}}</span>
                <span class="t-right"></span>
                <button type="button" class="t-btn secondary" data-action="spec-fav" title="Quitar de favoritas">★</button>
                <button type="button" class="t-btn" data-action="spec-roll">Tirar</button>
              </div>
            {{/each}}
          </div>
        </div>
        {{/if}}

        {{!-- Grupos por categoría --}}
        {{#each specs.groups as |group|}}
        <div class="t-card t-col" data-category="{{group.category}}">
          <h3 style="margin:0;">{{group.title}}</h3>
          <div class="t-col" style="gap:6px;">
            {{#each group.items}}
              <div class="t-row spec-row" data-spec="{{this.key}}" style="gap:8px; align-items:center;">
                <strong style="min-width:160px;">{{this.label}}</strong>
                <span class="muted" title="Atributo base">{{this.attrLabel}}</span>
                <span class="muted">Rango {{this.rank}} • Progreso {{this.progress}}/{{this.threshold}}</span>
                {{#if this.usesCalc}}<span class="t-badge accent" title="Tiene cálculos propios">calc</span>{{/if}}
                <span class="t-right"></span>
                <button type="button" class="t-btn secondary" data-action="spec-fav" title="Marcar favorita">{{#if this.fav}}★{{else}}☆{{/if}}</button>
                <button type="button" class="t-btn" data-action="spec-roll">Tirar</button>
              </div>
            {{/each}}
          </div>
        </div>
        {{/each}}

        <span class="muted">Consejo: marca con ★ las que más usas para tenerlas arriba.</span>
      </div>
      
      {{!-- === EQUIPO (SLOTS) === --}}
      <div class="t-card t-col">
        <h3 style="margin:0 0 6px 0;">Equipo</h3>

        <div class="t-grid t-grid-2" style="gap:12px;">
          <div class="t-field">
            <label>Mano principal</label>
            <select name="slot.mainHand">
              <option value="">— Ninguna —</option>
              {{#each inventory.options.mainHand}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Mano secundaria</label>
            <select name="slot.offHand">
              <option value="">— Ninguna —</option>
              {{#each inventory.options.offHand}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>

          <div class="t-field">
            <label>Escudo</label>
            <select name="slot.shield">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.shield}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>

          <div class="t-field">
            <label>Casco</label>
            <select name="slot.head">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.head}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Peto</label>
            <select name="slot.chest">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.chest}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Pantalón</label>
            <select name="slot.legs">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.legs}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Brazales</label>
            <select name="slot.bracers">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.bracers}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Botas</label>
            <select name="slot.boots">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.boots}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>

          <div class="t-field">
            <label>Insignia</label>
            <select name="slot.insignia">
              <option value="">— Ninguna —</option>
              {{#each inventory.options.insignia}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Amuleto</label>
            <select name="slot.amulet">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.amulet}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Colgante 1</label>
            <select name="slot.pendant1">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.pendant1}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="t-field">
            <label>Colgante 2</label>
            <select name="slot.pendant2">
              <option value="">— Ninguno —</option>
              {{#each inventory.options.pendant2}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
              {{/each}}
            </select>
          </div>
        </div>

        <span class="muted">Consejo: equipa un arma en la mano principal para que las tiradas la tomen por defecto.</span>
      </div>
    </section>
  </section>
</form>